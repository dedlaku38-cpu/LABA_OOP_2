<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Lab2XmlAnalysis.Models"
             xmlns:viewmodels="clr-namespace:Lab2XmlAnalysis.ViewModels"
             x:DataType="viewmodels:MainViewModel"
             x:Class="Lab2XmlAnalysis.MainPage"
             Title="XML Аналізатор (Варіант 4)"
             BackgroundColor="#f5f5f5">

    <ContentPage.Resources>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#007aff" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="CornerRadius" Value="5" />
            <Setter Property="Padding" Value="5,0" />
            <Setter Property="HeightRequest" Value="32" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="VisualStateManager.VisualStateGroups">
                <VisualStateGroupList>
                    <VisualStateGroup Name="CommonStates">
                        <VisualState Name="Normal">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#007aff" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="PointerOver">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#005ecb" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Pressed">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#004a9e" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Disabled">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#c0c0c0" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </Setter>
        </Style>

        <Style x:Key="DangerButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="BackgroundColor" Value="#dc3545" />
            <Setter Property="VisualStateManager.VisualStateGroups">
                <VisualStateGroupList>
                    <VisualStateGroup Name="CommonStates">
                        <VisualState Name="Normal">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#dc3545" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="PointerOver">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#c82333" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Pressed">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#b21f2d" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Disabled">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#c0c0c0" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="BackgroundColor" Value="#6c757d" />
            <Setter Property="VisualStateManager.VisualStateGroups">
                <VisualStateGroupList>
                    <VisualStateGroup Name="CommonStates">
                        <VisualState Name="Normal">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#6c757d" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="PointerOver">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#5a6268" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Pressed">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#495057" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Disabled">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#c0c0c0" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </Setter>
        </Style>

        <Style x:Key="GhostDangerButton" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#eeeeee" />
            <Setter Property="TextColor" Value="Black" />
            <Setter Property="BorderColor" Value="#aaaaaa" />
            <Setter Property="BorderWidth" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="VisualStateManager.VisualStateGroups">
                <VisualStateGroupList>
                    <VisualStateGroup Name="CommonStates">
                        <VisualState Name="Normal">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#eeeeee" />
                                <Setter Property="TextColor" Value="Black" />
                                <Setter Property="BorderColor" Value="#aaaaaa" />
                                <Setter Property="Opacity" Value="1" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="PointerOver">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#dc3545" />
                                <Setter Property="TextColor" Value="White" />
                                <Setter Property="BorderColor" Value="#dc3545" />
                                <Setter Property="Opacity" Value="1" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Pressed">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#a71d2a" />
                                <Setter Property="TextColor" Value="White" />
                                <Setter Property="BorderColor" Value="#a71d2a" />
                                <Setter Property="Opacity" Value="1" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="Disabled">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#888888" />
                                <Setter Property="TextColor" Value="#333333" />
                                <Setter Property="BorderColor" Value="Transparent" />
                                <Setter Property="Opacity" Value="0.3" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </Setter>
        </Style>

        <Style x:Key="CardView" TargetType="Border">
            <Setter Property="Stroke" Value="#e0e0e0" />
            <Setter Property="StrokeThickness" Value="1" />
            <Setter Property="BackgroundColor" Value="White" />
            <Setter Property="Padding" Value="15" />
            <Setter Property="StrokeShape" Value="RoundRectangle 10" />
            <Setter Property="Shadow">
                <Shadow Brush="Black" Offset="5,5" Radius="10" Opacity="0.1" />
            </Setter>
        </Style>

        <Style x:Key="CompactCardView" TargetType="Border" BasedOn="{StaticResource CardView}">
            <Setter Property="Padding" Value="10" />
        </Style>

        <Style TargetType="Label">
            <Setter Property="TextColor" Value="Black" />
        </Style>

        <Style x:Key="ScrollButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#808080" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="WidthRequest" Value="40" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="FontSize" Value="22" />
            <Setter Property="Opacity" Value="0.7" />
            <Setter Property="Shadow">
                <Shadow Brush="Black" Offset="2,2" Radius="5" Opacity="0.2" />
            </Setter>
            <Setter Property="VisualStateManager.VisualStateGroups">
                <VisualStateGroupList>
                    <VisualStateGroup Name="CommonStates">
                        <VisualState Name="Normal">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#808080" />
                                <Setter Property="Opacity" Value="0.7" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState Name="PointerOver">
                            <VisualState.Setters>
                                <Setter Property="BackgroundColor" Value="#606060" />
                                <Setter Property="Opacity" Value="1" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </Setter>
        </Style>
    </ContentPage.Resources>

    <Grid ColumnDefinitions="450, *, *" 
          RowDefinitions="*, Auto" 
          ColumnSpacing="10" RowSpacing="10" Padding="10">

        <Border Grid.Column="0" Grid.Row="0" Style="{StaticResource CardView}">
            <Grid RowDefinitions="Auto, *">
                <VerticalStackLayout Grid.Row="0" Spacing="10" Padding="0,0,0,10">
                    <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                        <Label Text="Параметри" FontAttributes="Bold" FontSize="18" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                    <BoxView HeightRequest="1" Color="#e0e0e0" />
                </VerticalStackLayout>
                <Grid Grid.Row="1">
                    <ScrollView x:Name="ParamsScrollView" Scrolled="OnParamsScrolled">
                        <VerticalStackLayout x:Name="ParamsContent" SizeChanged="OnContentSizeChanged" Spacing="12" Padding="0,0,5,45">
                            <Label Text="Джерело даних (Архів):" />
                            <Grid ColumnDefinitions="*, 45, 45" ColumnSpacing="5">
                                <Border Grid.Column="0" Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 8" BackgroundColor="#fdfdfd" HeightRequest="40" HorizontalOptions="Fill">
                                    <Picker ItemsSource="{Binding ArchiveList}" SelectedItem="{Binding SelectedArchive}" TextColor="Black" VerticalOptions="Center" />
                                </Border>
                                <Button Grid.Column="1" Text="📂" Command="{Binding OpenArchiveFolderCommand}" BackgroundColor="#eeeeee" TextColor="Black" BorderColor="#aaaaaa" BorderWidth="1" CornerRadius="8" Padding="0" HeightRequest="40" WidthRequest="40" HorizontalOptions="Center"/>
                                <Button Grid.Column="2" Text="🗑" ToolTipProperties.Text="Видалити архів" Command="{Binding DeleteCurrentArchiveCommand}" IsEnabled="{Binding IsDeleteEnabled}" Style="{StaticResource GhostDangerButton}" HeightRequest="40" WidthRequest="40" HorizontalOptions="Center"/>
                            </Grid>
                            <Label Text="Факультет:" />
                            <Border Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 8" BackgroundColor="#fdfdfd" HeightRequest="40">
                                <Picker ItemsSource="{Binding Faculties}" SelectedItem="{Binding SelectedFaculty}" TextColor="Black" VerticalOptions="Center" />
                            </Border>
                            <Label Text="Кафедра:" />
                            <Border Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 8" BackgroundColor="#fdfdfd" HeightRequest="40">
                                <Picker ItemsSource="{Binding Departments}" SelectedItem="{Binding SelectedDepartment}" TextColor="Black" VerticalOptions="Center" />
                            </Border>
                            <Label Text="Назва матеріалу (частково):" />
                            <Border Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 8" BackgroundColor="#fdfdfd" HeightRequest="40">
                                <Entry Text="{Binding TitleQuery}" Placeholder="Введіть назву..." TextColor="Black" VerticalOptions="Center" PlaceholderColor="#888888" />
                            </Border>
                            <Label Text="ПІБ Автора (частково):" />
                            <Border Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 8" BackgroundColor="#fdfdfd" HeightRequest="40">
                                <Entry Text="{Binding AuthorQuery}" Placeholder="Введіть ПІБ..." TextColor="Black" VerticalOptions="Center" PlaceholderColor="#888888" />
                            </Border>
                            <Label Text="Метод аналізу:" />
                            <Border Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 8" BackgroundColor="#fdfdfd" HeightRequest="40">
                                <Picker ItemsSource="{Binding AnalysisTypes}" SelectedItem="{Binding SelectedAnalysisType}" TextColor="Black" VerticalOptions="Center" />
                            </Border>
                        </VerticalStackLayout>
                    </ScrollView>
                    <VerticalStackLayout VerticalOptions="End" HorizontalOptions="End" Margin="0,0,10,10" Spacing="8">
                        <Button x:Name="ParamsScrollUpButton" Text="↑" Style="{StaticResource ScrollButtonStyle}" Clicked="OnParamsScrollUp" IsVisible="False" Margin="0" />
                        <Button x:Name="ParamsScrollDownButton" Text="↓" Style="{StaticResource ScrollButtonStyle}" Clicked="OnParamsScrollDown" IsVisible="False" Margin="0" />
                    </VerticalStackLayout>
                </Grid>
            </Grid>
        </Border>

        <Border Grid.Column="1" Grid.Row="0" Style="{StaticResource CardView}">
            <Grid RowDefinitions="Auto, *">

                <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Padding="0,0,0,10">
                    <VerticalStackLayout Grid.Column="0" Spacing="2" VerticalOptions="Center">
                        <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                            <Label Text="Результати Пошуку" FontAttributes="Bold" FontSize="18" VerticalOptions="Center" />
                            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" Color="#007aff" HeightRequest="20" WidthRequest="20" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <Label Text="{Binding FoundCountText}" FontSize="13" TextColor="#888" />
                    </VerticalStackLayout>
                    <VerticalStackLayout Grid.Column="1" Spacing="2" HorizontalOptions="End" VerticalOptions="Center">
                        <Label Text="Сортування:" FontSize="12" TextColor="#666" HorizontalOptions="End" />
                        <Border Stroke="#aaaaaa" StrokeThickness="1" StrokeShape="RoundRectangle 6" BackgroundColor="#fdfdfd" HeightRequest="30" WidthRequest="160">
                            <Picker ItemsSource="{Binding SortOptions}" SelectedItem="{Binding SelectedSortOption}" TextColor="Black" FontSize="12" VerticalOptions="Center" />
                        </Border>
                    </VerticalStackLayout>
                </Grid>

                <Grid Grid.Row="1" Margin="0,10,0,0">
                    <ScrollView x:Name="ResultsScrollView" Scrolled="OnResultsScrolled">
                        <VerticalStackLayout x:Name="ResultsContent" 
                                             SizeChanged="OnContentSizeChanged" 
                                             BindableLayout.ItemsSource="{Binding SearchResultsList}" 
                                             Spacing="10" 
                                             Padding="0,0,0,45">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:Material">
                                    <Border Stroke="#e0e0e0" StrokeThickness="1" StrokeShape="RoundRectangle 8" Padding="10" BackgroundColor="White">
                                        <VerticalStackLayout Spacing="5">
                                            <Label Text="{Binding Title, TargetNullValue='[Без назви]'}" FontAttributes="Bold" TextColor="Black" FontSize="16" LineBreakMode="TailTruncation" />
                                            <Label Text="{Binding Author.FullName, StringFormat='Автор: {0}', TargetNullValue='[Невідомий автор]'}" FontSize="13" TextColor="#333" LineBreakMode="TailTruncation" />
                                            <Label Text="{Binding Volume, StringFormat='Обсяг: {0}', TargetNullValue='Обсяг: не вказано'}" FontSize="12" TextColor="#666" LineBreakMode="TailTruncation" />
                                            <Button Text="Детальніше" Style="{StaticResource SecondaryButton}" FontSize="12" Padding="0" HeightRequest="30" Margin="0,5,0,0" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=ShowDetailsCommand}" CommandParameter="{Binding .}" />
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </ScrollView>

                    <Label Text="Нічого не знайдено :_(" IsVisible="{Binding IsNoResultsFound}" FontSize="18" TextColor="#888888" HorizontalOptions="Center" VerticalOptions="Center" HorizontalTextAlignment="Center" />

                    <VerticalStackLayout VerticalOptions="End" HorizontalOptions="End" Margin="0,0,10,10" Spacing="8">
                        <Button x:Name="ResultsScrollUpButton" Text="↑" Style="{StaticResource ScrollButtonStyle}" Clicked="OnResultsScrollUp" IsVisible="False" Margin="0" />
                        <Button x:Name="ResultsScrollDownButton" Text="↓" Style="{StaticResource ScrollButtonStyle}" Clicked="OnResultsScrollDown" IsVisible="False" Margin="0" />
                    </VerticalStackLayout>
                </Grid>
            </Grid>
        </Border>

        <Border Grid.Column="2" Grid.Row="0" Style="{StaticResource CardView}">
            <Grid RowDefinitions="Auto, *">
                <Label Grid.Row="0" Text="Повна картка" FontAttributes="Bold" FontSize="18" />
                <ScrollView Grid.Row="1" Margin="0,10,0,0">
                    <VerticalStackLayout Spacing="15" IsVisible="{Binding IsMaterialSelected}">
                        <VerticalStackLayout Spacing="5" VerticalOptions="Start">
                            <Label Text="{Binding SelectedMaterial.Title}" FontAttributes="Bold" FontSize="18" LineBreakMode="WordWrap" TextColor="#333" />
                            <Label Text="{Binding SelectedMaterial.Author.FullName, StringFormat='Автор: {0}'}" FontSize="14" TextColor="#555" />
                            <Label Text="{Binding SelectedMaterial.CreationDate, StringFormat='Дата публікації: {0}'}" FontSize="13" TextColor="#777" />
                        </VerticalStackLayout>
                        <BoxView HeightRequest="1" Color="#e0e0e0" />
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Деталі матеріалу" FontAttributes="Bold" FontSize="16" />
                            <Label Text="{Binding SelectedMaterial.Type, StringFormat='Тип: {0}'}" FontSize="14" />
                            <Label Text="{Binding SelectedMaterial.Volume, StringFormat='Обсяг: {0}'}" FontSize="14" />
                            <Label Text="{Binding SelectedMaterial.Author.Faculty, StringFormat='Факультет: {0}'}" FontSize="14" />
                            <Label Text="{Binding SelectedMaterial.Author.Department, StringFormat='Кафедра: {0}'}" FontSize="14" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
                <Label Grid.Row="1" Text="Оберіть матеріал для перегляду..." TextColor="#888" VerticalOptions="Center" HorizontalOptions="Center" IsVisible="{Binding IsPlaceholderVisible}" />
            </Grid>
        </Border>

        <Border Grid.Column="0" Grid.Row="1" Style="{StaticResource CompactCardView}">
            <VerticalStackLayout Spacing="4">
                <Label Text="Дії" FontAttributes="Bold" FontSize="14" />
                <BoxView HeightRequest="1" Color="#e0e0e0" />

                <Button Text="Знайти" Command="{Binding SearchCommand}" Style="{StaticResource PrimaryButton}" />
                <Button Text="Зберегти вибірку в Архів" Command="{Binding SaveFilteredArchiveCommand}" Style="{StaticResource PrimaryButton}" />
                <Button Text="Трансформувати в HTML" Command="{Binding TransformCommand}" Style="{StaticResource PrimaryButton}" />
                <Button Text="Зберегти HTML" Command="{Binding SaveHtmlCommand}" Style="{StaticResource PrimaryButton}" />

                <Button Text="Очистити" Command="{Binding ClearCommand}" Style="{StaticResource DangerButton}" />
                <Button Text="Вийти" Command="{Binding ExitCommand}" Style="{StaticResource SecondaryButton}" />
            </VerticalStackLayout>
        </Border>

        <Border Grid.Column="1" Grid.ColumnSpan="2" Grid.Row="1" Style="{StaticResource CompactCardView}">
            <Grid RowDefinitions="Auto, *">
                <Label Grid.Row="0" Text="HTML Результат Трансформації" FontAttributes="Bold" FontSize="14" />
                <WebView Grid.Row="1" Margin="0,5,0,0">
                    <WebView.Source>
                        <HtmlWebViewSource Html="{Binding HtmlContent}" />
                    </WebView.Source>
                </WebView>
            </Grid>
        </Border>

    </Grid>
</ContentPage>